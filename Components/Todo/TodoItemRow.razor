@using TodoList.Models
@using TodoList.Models.Enums
@using TodoList.Helpers
@using TodoList.Components.Shared

<div class="todo-card @GetStatusClass() @(Item.Status == TodoItemStatus.Done ? "completed" : "") @(Depth > 0 ? "subtask-card" : "")"
     data-testid="@(Depth > 0 ? "subtask-card" : "todo-card")">
	<div class="todo-card-left">
		<button class="todo-checkbox @(Item.Status == TodoItemStatus.Done ? "checked" : "")"
		        @onclick="ToggleComplete"
		        title="@(Item.Status == TodoItemStatus.Done ? "Mark as incomplete" : "Mark as complete")"
		        aria-label="@(Item.Status == TodoItemStatus.Done ? "Mark as incomplete" : "Mark as complete")">
			@if (Item.Status == TodoItemStatus.Done)
			{
				<svg class="check-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
					<path d="M5 12l5 5L20 7"/>
				</svg>
			}
		</button>
		@if (Item.HasSubTasks || Depth == 0)
		{
			<button class="expand-toggle @(_isExpanded ? "expanded" : "")"
			        @onclick="() => _isExpanded = !_isExpanded"
			        aria-label="@(_isExpanded ? "Collapse subtasks" : "Expand subtasks")"
			        aria-expanded="@_isExpanded.ToString().ToLower()"
			        data-testid="expand-toggle">
				<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
					<path d="M9 18l6-6-6-6"/>
				</svg>
			</button>
		}
	</div>

	<div class="todo-card-content">
		<div class="todo-header">
			@if (_isEditingTitle && Depth > 0)
			{
				<input @ref="_titleInputRef"
				       class="title-edit-input"
				       @bind="_editingTitleValue"
				       @bind:event="oninput"
				       @onkeydown="HandleTitleKeyDown"
				       data-testid="subtask-title-input"
				       aria-label="Edit subtask title" />
			}
			else
			{
				<h3 class="todo-title @(Item.Status == TodoItemStatus.Done ? "done" : "")">@Item.Title</h3>
			}
			<div class="todo-badges">
				<span class="priority-badge priority-@Item.Priority.ToString().ToLower()">
					@Item.Priority
				</span>
				@if (Item.Status != TodoItemStatus.None && Item.Status != TodoItemStatus.Done)
				{
					<span class="status-badge status-@Item.Status.ToString().ToLower()">
						@GetStatusLabel()
					</span>
				}
			</div>
		</div>

		@if (!string.IsNullOrWhiteSpace(Item.Description) && Depth == 0)
		{
			<p class="todo-description">@Item.Description</p>
		}

		<div class="todo-meta">
			@if (Depth == 0)
			{
				<span class="meta-item">
					<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<circle cx="12" cy="12" r="10"/>
						<path d="M12 6v6l4 2"/>
					</svg>
					@Item.CreatedAt.ToString("MMM d, yyyy")
				</span>
			}
			@if (Item.HasSubTasks)
			{
				<span class="meta-item subtask-progress">
					<div class="subtask-progress-bar-track" data-testid="subtask-progress-bar">
						<div class="subtask-progress-bar"
						     style="width: @(Item.SubTaskCount > 0 ? (int)((double)Item.SubTaskDoneCount / Item.SubTaskCount * 100) : 0)%"></div>
					</div>
					@Item.SubTaskDoneCount/@Item.SubTaskCount
				</span>
			}
		</div>
	</div>

	<div class="todo-card-actions">
		@if (Depth == 0)
		{
			<select class="status-select"
			        value="@Item.Status"
			        @onchange="HandleStatusChange"
			        title="Change status">
				@foreach (var status in Enum.GetValues<TodoItemStatus>())
				{
					<option value="@status" selected="@(Item.Status == status)">@GetStatusLabel(status)</option>
				}
			</select>
		}

		<div class="action-buttons">
			@if (Depth > 0)
			{
				<button class="action-btn edit-btn" @onclick="StartEditTitle"
				        title="Edit subtask title"
				        aria-label="Edit subtask title"
				        data-testid="subtask-edit-btn">
					<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
						<path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
					</svg>
				</button>
			}
			else
			{
				<button class="action-btn edit-btn" @onclick="HandleEdit" title="Edit">
					<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
						<path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
					</svg>
				</button>
			}
			<button class="action-btn delete-btn" @onclick="HandleDelete"
			        title="Delete"
			        aria-label="Delete"
			        data-testid="@(Depth > 0 ? "subtask-delete-btn" : "delete-btn")">
				<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
					<path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
				</svg>
			</button>
		</div>
	</div>
</div>

@if (_isExpanded && Depth == 0)
{
	<div class="subtask-tree" data-testid="subtask-tree">
		@foreach (var sub in Item.SubTasks)
		{
			<div class="subtask-item-wrapper" @key="sub.Id">
				<TodoItemRow Item="sub" Depth="1"
				             OnSave="HandleSubTaskSave"
				             OnDelete="HandleSubTaskDelete"
				             OnEdit="OnEdit" />
			</div>
		}

		@if (_showAddSubTask)
		{
			<div class="add-subtask-form">
				<input @ref="_addSubTaskInputRef"
				       class="add-subtask-input"
				       placeholder="New subtask title..."
				       @bind="_newSubTaskTitle"
				       @bind:event="oninput"
				       @onkeydown="HandleAddSubTaskKeyDown"
				       data-testid="add-subtask-input"
				       aria-label="New subtask title" />
			</div>
		}
		else
		{
			<button class="add-subtask-trigger"
			        @onclick="ShowAddSubTask"
			        data-testid="add-subtask-trigger"
			        aria-label="Add subtask">
				<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
					<path d="M12 5v14M5 12h14"/>
				</svg>
				Add subtask
			</button>
		}
	</div>
}

<style>
	.todo-card {
		display: flex;
		align-items: flex-start;
		gap: var(--space-4);
		padding: var(--space-4) var(--space-5);
		background: var(--surface);
		border: 1px solid var(--border-light);
		border-radius: var(--radius-lg);
		margin-bottom: var(--space-3);
		transition: all var(--transition-fast);
		animation: fadeIn var(--transition-base) ease-out;
	}

	.todo-card:hover {
		border-color: var(--border);
		box-shadow: var(--shadow-md);
		transform: translateY(-1px);
	}

	.todo-card.completed {
		background: var(--gray-50);
		opacity: 0.8;
	}

	.todo-card.completed:hover {
		opacity: 1;
	}

	/* Subtask card variant */
	.todo-card.subtask-card {
		padding: var(--space-2) var(--space-3);
		background: var(--gray-50);
		margin-bottom: var(--space-2);
		border-radius: var(--radius-md);
	}

	.todo-card.subtask-card .todo-title {
		font-size: 0.875rem;
		font-weight: 500;
	}

	.todo-card.subtask-card:hover {
		transform: translateY(0);
		box-shadow: var(--shadow-sm);
	}

	/* Checkbox */
	.todo-card-left {
		flex-shrink: 0;
		padding-top: 2px;
		display: flex;
		flex-direction: column;
		align-items: center;
		gap: var(--space-1);
	}

	.todo-checkbox {
		width: 24px;
		height: 24px;
		border: 2px solid var(--border);
		border-radius: var(--radius-md);
		background: var(--surface);
		cursor: pointer;
		display: flex;
		align-items: center;
		justify-content: center;
		transition: all var(--transition-fast);
	}

	.todo-card.subtask-card .todo-checkbox {
		width: 18px;
		height: 18px;
	}

	.todo-checkbox:hover {
		border-color: var(--primary);
		background: var(--primary-50);
	}

	.todo-checkbox.checked {
		background: var(--success);
		border-color: var(--success);
	}

	.todo-checkbox.checked:hover {
		background: #059669;
		border-color: #059669;
	}

	.check-icon {
		color: white;
		animation: checkmark 0.3s ease-out;
	}

	@@keyframes checkmark {
		0% { transform: scale(0); }
		50% { transform: scale(1.2); }
		100% { transform: scale(1); }
	}

	/* Expand toggle */
	.expand-toggle {
		background: transparent;
		border: none;
		cursor: pointer;
		color: var(--text-muted);
		padding: 2px;
		border-radius: var(--radius-sm);
		display: flex;
		align-items: center;
		justify-content: center;
		transition: all var(--transition-fast);
		flex-shrink: 0;
	}

	.expand-toggle:hover {
		color: var(--text-primary);
		background: var(--gray-100);
	}

	.expand-toggle svg {
		transition: transform var(--transition-base);
		transform: rotate(0deg);
	}

	.expand-toggle.expanded svg {
		transform: rotate(90deg);
	}

	/* Content */
	.todo-card-content {
		flex: 1;
		min-width: 0;
	}

	.todo-header {
		display: flex;
		align-items: flex-start;
		justify-content: space-between;
		gap: var(--space-3);
		margin-bottom: var(--space-2);
	}

	.todo-title {
		font-size: 1rem;
		font-weight: 600;
		color: var(--text-primary);
		margin: 0;
		line-height: 1.4;
		word-break: break-word;
	}

	.todo-title.done {
		text-decoration: line-through;
		color: var(--text-muted);
	}

	.title-edit-input {
		flex: 1;
		font-size: 0.875rem;
		font-weight: 500;
		padding: var(--space-1) var(--space-2);
		border: 1px solid var(--primary);
		border-radius: var(--radius-sm);
		background: var(--surface);
		color: var(--text-primary);
		outline: none;
		box-shadow: 0 0 0 2px var(--primary-50);
		min-width: 0;
	}

	.todo-badges {
		display: flex;
		gap: var(--space-2);
		flex-shrink: 0;
	}

	.priority-badge, .status-badge {
		font-size: 0.6875rem;
		font-weight: 600;
		padding: 0.125rem 0.5rem;
		border-radius: var(--radius-full);
		text-transform: uppercase;
		letter-spacing: 0.025em;
	}

	.priority-badge.priority-low {
		background: var(--success-light);
		color: #065f46;
	}

	.priority-badge.priority-medium {
		background: var(--warning-light);
		color: #92400e;
	}

	.priority-badge.priority-high {
		background: #ffedd5;
		color: #c2410c;
	}

	.priority-badge.priority-emergency {
		background: var(--danger-light);
		color: #991b1b;
	}

	.status-badge.status-new {
		background: var(--info-light);
		color: #1e40af;
	}

	.status-badge.status-inprogress {
		background: #fef3c7;
		color: #92400e;
	}

	.status-badge.status-abandoned {
		background: var(--gray-200);
		color: var(--text-secondary);
	}

	.status-badge.status-archived {
		background: var(--gray-200);
		color: var(--text-secondary);
	}

	.todo-description {
		font-size: 0.875rem;
		color: var(--text-secondary);
		margin: 0 0 var(--space-2);
		line-height: 1.5;
		display: -webkit-box;
		-webkit-line-clamp: 2;
		-webkit-box-orient: vertical;
		overflow: hidden;
	}

	.todo-meta {
		display: flex;
		gap: var(--space-4);
		align-items: center;
	}

	.meta-item {
		display: flex;
		align-items: center;
		gap: var(--space-1);
		font-size: 0.75rem;
		color: var(--text-muted);
	}

	.meta-item svg {
		opacity: 0.7;
	}

	/* Subtask progress bar */
	.subtask-progress-bar-track {
		display: inline-block;
		width: 60px;
		height: 4px;
		background: var(--gray-200);
		border-radius: var(--radius-full);
		overflow: hidden;
		vertical-align: middle;
	}

	.subtask-progress-bar {
		height: 100%;
		background: linear-gradient(90deg, var(--primary) 0%, var(--success) 100%);
		border-radius: var(--radius-full);
		transition: width 0.3s ease;
	}

	/* Actions */
	.todo-card-actions {
		display: flex;
		flex-direction: column;
		align-items: flex-end;
		gap: var(--space-2);
		flex-shrink: 0;
	}

	.status-select {
		padding: var(--space-1) var(--space-2);
		border: 1px solid var(--border);
		border-radius: var(--radius-md);
		font-size: 0.75rem;
		background: var(--surface);
		color: var(--text-secondary);
		cursor: pointer;
		min-width: 100px;
	}

	.status-select:focus {
		outline: none;
		border-color: var(--primary);
	}

	.action-buttons {
		display: flex;
		gap: var(--space-1);
		opacity: 0;
		transition: opacity var(--transition-fast);
	}

	.todo-card:hover .action-buttons {
		opacity: 1;
	}

	.action-btn {
		width: 32px;
		height: 32px;
		display: flex;
		align-items: center;
		justify-content: center;
		border: none;
		border-radius: var(--radius-md);
		background: transparent;
		color: var(--text-muted);
		cursor: pointer;
		transition: all var(--transition-fast);
	}

	.todo-card.subtask-card .action-btn {
		width: 26px;
		height: 26px;
	}

	.action-btn:hover {
		background: var(--gray-100);
		color: var(--text-primary);
	}

	.delete-btn:hover {
		background: var(--danger-light);
		color: var(--danger);
	}

	/* Subtask tree */
	.subtask-tree {
		margin-left: 24px;
		padding-left: var(--space-4);
		border-left: 2px solid var(--border-light);
		margin-bottom: var(--space-3);
		padding-top: var(--space-1);
	}

	.subtask-item-wrapper {
		position: relative;
	}

	.subtask-item-wrapper::before {
		content: '';
		position: absolute;
		left: calc(-1 * var(--space-4) - 1px);
		top: 18px;
		width: var(--space-4);
		height: 2px;
		background: var(--border-light);
	}

	/* Add subtask */
	.add-subtask-trigger {
		display: flex;
		align-items: center;
		gap: var(--space-2);
		padding: var(--space-2) var(--space-3);
		border: 1px dashed var(--border);
		border-radius: var(--radius-md);
		background: transparent;
		color: var(--text-muted);
		font-size: 0.8125rem;
		cursor: pointer;
		width: 100%;
		margin-top: var(--space-2);
		transition: all var(--transition-fast);
	}

	.add-subtask-trigger:hover {
		border-color: var(--primary);
		color: var(--primary);
		background: var(--primary-50);
		transform: translateY(-1px);
	}

	.add-subtask-form {
		margin-top: var(--space-2);
	}

	.add-subtask-input {
		width: 100%;
		padding: var(--space-2) var(--space-3);
		border: 1px solid var(--primary);
		border-radius: var(--radius-md);
		font-size: 0.8125rem;
		background: var(--surface);
		color: var(--text-primary);
		outline: none;
		box-shadow: 0 0 0 3px var(--primary-50);
		box-sizing: border-box;
	}

	/* Responsive */
	@@media (max-width: 640px) {
		.todo-card {
			flex-wrap: wrap;
		}

		.todo-card-content {
			order: 1;
			width: calc(100% - 40px);
		}

		.todo-card-actions {
			order: 2;
			width: 100%;
			flex-direction: row;
			justify-content: space-between;
			margin-top: var(--space-2);
			padding-top: var(--space-2);
			border-top: 1px solid var(--border-light);
		}

		.action-buttons {
			opacity: 1;
		}

		.todo-header {
			flex-direction: column;
		}

		.subtask-tree {
			margin-left: 12px;
		}
	}
</style>

@code {
	[Parameter, EditorRequired]
	public TodoItem Item { get; set; } = default!;

	[Parameter]
	public int Depth { get; set; } = 0;

	[Parameter]
	public EventCallback<TodoItem> OnEdit { get; set; }

	[Parameter]
	public EventCallback<TodoItem> OnDelete { get; set; }

	[Parameter]
	public EventCallback<TodoItem> OnSave { get; set; }

	private bool _isExpanded = true;
	private bool _isEditingTitle = false;
	private string _editingTitleValue = string.Empty;
	private string _newSubTaskTitle = string.Empty;
	private bool _showAddSubTask = false;
	private bool _focusTitleInput = false;
	private bool _focusAddInput = false;
	private ElementReference _titleInputRef;
	private ElementReference _addSubTaskInputRef;

	protected override async Task OnAfterRenderAsync(bool firstRender)
	{
		if (_focusTitleInput)
		{
			_focusTitleInput = false;
			try { await _titleInputRef.FocusAsync(); } catch { }
		}
		if (_focusAddInput)
		{
			_focusAddInput = false;
			try { await _addSubTaskInputRef.FocusAsync(); } catch { }
		}
	}

	private async Task HandleEdit() => await OnEdit.InvokeAsync(Item);

	private async Task HandleDelete() => await OnDelete.InvokeAsync(Item);

	private async Task HandleStatusChange(ChangeEventArgs e)
	{
		if (Enum.TryParse<TodoItemStatus>(e.Value?.ToString(), out var status))
		{
			Item.Status = status;
			if (status == TodoItemStatus.Done && !Item.CompletedAt.HasValue)
				Item.CompletedAt = DateTime.Now;
			if (status == TodoItemStatus.InProgress && !Item.StartedAt.HasValue)
				Item.StartedAt = DateTime.Now;
			await OnSave.InvokeAsync(Item);
		}
	}

	private async Task ToggleComplete()
	{
		var newStatus = Item.Status == TodoItemStatus.Done ? TodoItemStatus.New : TodoItemStatus.Done;
		Item.Status = newStatus;
		if (newStatus == TodoItemStatus.Done && !Item.CompletedAt.HasValue)
			Item.CompletedAt = DateTime.Now;
		if (newStatus == TodoItemStatus.InProgress && !Item.StartedAt.HasValue)
			Item.StartedAt = DateTime.Now;
		await OnSave.InvokeAsync(Item);
	}

	private async Task HandleSubTaskSave(TodoItem _) => await OnSave.InvokeAsync(Item);

	private async Task HandleSubTaskDelete(TodoItem sub)
	{
		Item.SubTasks.Remove(sub);
		await OnSave.InvokeAsync(Item);
	}

	private void ShowAddSubTask()
	{
		_showAddSubTask = true;
		_newSubTaskTitle = string.Empty;
		_focusAddInput = true;
	}

	private async Task CommitAddSubTask()
	{
		if (string.IsNullOrWhiteSpace(_newSubTaskTitle))
		{
			_showAddSubTask = false;
			return;
		}
		Item.SubTasks.Add(new TodoItem
		{
			Title = _newSubTaskTitle.Trim(),
			ProjectId = Item.ProjectId,
			Status = TodoItemStatus.New
		});
		_newSubTaskTitle = string.Empty;
		_showAddSubTask = false;
		await OnSave.InvokeAsync(Item);
	}

	private async Task HandleAddSubTaskKeyDown(KeyboardEventArgs e)
	{
		if (e.Key == "Enter") await CommitAddSubTask();
		else if (e.Key == "Escape")
		{
			_showAddSubTask = false;
			_newSubTaskTitle = string.Empty;
		}
	}

	private void StartEditTitle()
	{
		_editingTitleValue = Item.Title;
		_isEditingTitle = true;
		_focusTitleInput = true;
	}

	private async Task CommitEditTitle()
	{
		if (!_isEditingTitle) return;
		if (!string.IsNullOrWhiteSpace(_editingTitleValue))
			Item.Title = _editingTitleValue.Trim();
		_isEditingTitle = false;
		await OnSave.InvokeAsync(Item);
	}

	private async Task HandleTitleKeyDown(KeyboardEventArgs e)
	{
		if (e.Key == "Enter") await CommitEditTitle();
		else if (e.Key == "Escape") _isEditingTitle = false;
	}

	private string GetStatusClass() => Item.Status switch
	{
		TodoItemStatus.Done => "status-done",
		TodoItemStatus.InProgress => "status-in-progress",
		_ => ""
	};

	private string GetStatusLabel() => Item.Status switch
	{
		TodoItemStatus.InProgress => "In Progress",
		_ => Item.Status.ToString()
	};

	private string GetStatusLabel(TodoItemStatus status) => status switch
	{
		TodoItemStatus.InProgress => "In Progress",
		_ => status.ToString()
	};
}
