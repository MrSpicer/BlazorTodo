@using TodoList.Models
@using TodoList.Models.Enums
@using TodoList.Helpers
@using TodoList.Components.Shared

<div class="todo-card @GetStatusClass() @(Item.Status == TodoItemStatus.Done ? "completed" : "")">
    <div class="todo-card-left">
        <button class="todo-checkbox @(Item.Status == TodoItemStatus.Done ? "checked" : "")"
                @onclick="ToggleComplete"
                title="@(Item.Status == TodoItemStatus.Done ? "Mark as incomplete" : "Mark as complete")">
            @if (Item.Status == TodoItemStatus.Done)
            {
                <svg class="check-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                    <path d="M5 12l5 5L20 7"/>
                </svg>
            }
        </button>
    </div>
    
    <div class="todo-card-content">
        <div class="todo-header">
            <h3 class="todo-title @(Item.Status == TodoItemStatus.Done ? "done" : "")">@Item.Title</h3>
            <div class="todo-badges">
                <span class="priority-badge priority-@Item.Priority.ToString().ToLower()">
                    @Item.Priority
                </span>
                @if (Item.Status != TodoItemStatus.None && Item.Status != TodoItemStatus.Done)
                {
                    <span class="status-badge status-@Item.Status.ToString().ToLower()">
                        @GetStatusLabel()
                    </span>
                }
            </div>
        </div>
        
        @if (!string.IsNullOrWhiteSpace(Item.Description))
        {
            <p class="todo-description">@Item.Description</p>
        }
        
        <div class="todo-meta">
            <span class="meta-item">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M12 6v6l4 2"/>
                </svg>
                @Item.CreatedAt.ToString("MMM d, yyyy")
            </span>
        </div>
    </div>
    
    <div class="todo-card-actions">
        <select class="status-select" 
                value="@Item.Status" 
                @onchange="HandleStatusChange"
                title="Change status">
            @foreach (var status in Enum.GetValues<TodoItemStatus>())
            {
                <option value="@status" selected="@(Item.Status == status)">@GetStatusLabel(status)</option>
            }
        </select>
        
        <div class="action-buttons">
            <button class="action-btn edit-btn" @onclick="HandleEdit" title="Edit">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                </svg>
            </button>
            <button class="action-btn delete-btn" @onclick="HandleDelete" title="Delete">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                </svg>
            </button>
        </div>
    </div>
</div>

<style>
    .todo-card {
        display: flex;
        align-items: flex-start;
        gap: var(--space-4);
        padding: var(--space-4) var(--space-5);
        background: var(--surface);
        border: 1px solid var(--border-light);
        border-radius: var(--radius-lg);
        margin-bottom: var(--space-3);
        transition: all var(--transition-fast);
        animation: fadeIn var(--transition-base) ease-out;
    }
    
    .todo-card:hover {
        border-color: var(--border);
        box-shadow: var(--shadow-md);
        transform: translateY(-1px);
    }
    
    .todo-card.completed {
        background: var(--gray-50);
        opacity: 0.8;
    }
    
    .todo-card.completed:hover {
        opacity: 1;
    }
    
    /* Checkbox */
    .todo-card-left {
        flex-shrink: 0;
        padding-top: 2px;
    }
    
    .todo-checkbox {
        width: 24px;
        height: 24px;
        border: 2px solid var(--border);
        border-radius: var(--radius-md);
        background: var(--surface);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all var(--transition-fast);
    }
    
    .todo-checkbox:hover {
        border-color: var(--primary);
        background: var(--primary-50);
    }
    
    .todo-checkbox.checked {
        background: var(--success);
        border-color: var(--success);
    }
    
    .todo-checkbox.checked:hover {
        background: #059669;
        border-color: #059669;
    }
    
    .check-icon {
        color: white;
        animation: checkmark 0.3s ease-out;
    }
    
    @@keyframes checkmark {
        0% { transform: scale(0); }
        50% { transform: scale(1.2); }
        100% { transform: scale(1); }
    }
    
    /* Content */
    .todo-card-content {
        flex: 1;
        min-width: 0;
    }
    
    .todo-header {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: var(--space-3);
        margin-bottom: var(--space-2);
    }
    
    .todo-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0;
        line-height: 1.4;
        word-break: break-word;
    }
    
    .todo-title.done {
        text-decoration: line-through;
        color: var(--text-muted);
    }
    
    .todo-badges {
        display: flex;
        gap: var(--space-2);
        flex-shrink: 0;
    }
    
    .priority-badge, .status-badge {
        font-size: 0.6875rem;
        font-weight: 600;
        padding: 0.125rem 0.5rem;
        border-radius: var(--radius-full);
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }
    
    .priority-badge.priority-low {
        background: var(--success-light);
        color: #065f46;
    }
    
    .priority-badge.priority-medium {
        background: var(--warning-light);
        color: #92400e;
    }
    
    .priority-badge.priority-high {
        background: #ffedd5;
        color: #c2410c;
    }
    
    .priority-badge.priority-emergency {
        background: var(--danger-light);
        color: #991b1b;
    }
    
    .status-badge.status-new {
        background: var(--info-light);
        color: #1e40af;
    }
    
    .status-badge.status-inprogress {
        background: #fef3c7;
        color: #92400e;
    }
    
    .status-badge.status-abandoned {
        background: var(--gray-200);
        color: var(--text-secondary);
    }
    
    .status-badge.status-archived {
        background: var(--gray-200);
        color: var(--text-secondary);
    }
    
    .todo-description {
        font-size: 0.875rem;
        color: var(--text-secondary);
        margin: 0 0 var(--space-2);
        line-height: 1.5;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    
    .todo-meta {
        display: flex;
        gap: var(--space-4);
    }
    
    .meta-item {
        display: flex;
        align-items: center;
        gap: var(--space-1);
        font-size: 0.75rem;
        color: var(--text-muted);
    }
    
    .meta-item svg {
        opacity: 0.7;
    }
    
    /* Actions */
    .todo-card-actions {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: var(--space-2);
        flex-shrink: 0;
    }
    
    .status-select {
        padding: var(--space-1) var(--space-2);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        font-size: 0.75rem;
        background: var(--surface);
        color: var(--text-secondary);
        cursor: pointer;
        min-width: 100px;
    }
    
    .status-select:focus {
        outline: none;
        border-color: var(--primary);
    }
    
    .action-buttons {
        display: flex;
        gap: var(--space-1);
        opacity: 0;
        transition: opacity var(--transition-fast);
    }
    
    .todo-card:hover .action-buttons {
        opacity: 1;
    }
    
    .action-btn {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        border-radius: var(--radius-md);
        background: transparent;
        color: var(--text-muted);
        cursor: pointer;
        transition: all var(--transition-fast);
    }
    
    .action-btn:hover {
        background: var(--gray-100);
        color: var(--text-primary);
    }
    
    .delete-btn:hover {
        background: var(--danger-light);
        color: var(--danger);
    }
    
    /* Responsive */
    @@media (max-width: 640px) {
        .todo-card {
            flex-wrap: wrap;
        }
        
        .todo-card-content {
            order: 1;
            width: calc(100% - 40px);
        }
        
        .todo-card-actions {
            order: 2;
            width: 100%;
            flex-direction: row;
            justify-content: space-between;
            margin-top: var(--space-2);
            padding-top: var(--space-2);
            border-top: 1px solid var(--border-light);
        }
        
        .action-buttons {
            opacity: 1;
        }
        
        .todo-header {
            flex-direction: column;
        }
    }
</style>

@code {
    [Parameter, EditorRequired]
    public TodoItem Item { get; set; } = default!;

    [Parameter]
    public EventCallback<TodoItem> OnEdit { get; set; }

    [Parameter]
    public EventCallback<TodoItem> OnDelete { get; set; }

    [Parameter]
    public EventCallback<(TodoItem, TodoItemStatus)> OnStatusChange { get; set; }

    private async Task HandleEdit() => await OnEdit.InvokeAsync(Item);

    private async Task HandleDelete() => await OnDelete.InvokeAsync(Item);

    private async Task HandleStatusChange(ChangeEventArgs e)
    {
        if (Enum.TryParse<TodoItemStatus>(e.Value?.ToString(), out var status))
            await OnStatusChange.InvokeAsync((Item, status));
    }
    
    private async Task ToggleComplete()
    {
        var newStatus = Item.Status == TodoItemStatus.Done ? TodoItemStatus.New : TodoItemStatus.Done;
        await OnStatusChange.InvokeAsync((Item, newStatus));
    }
    
    private string GetStatusClass() => Item.Status switch
    {
        TodoItemStatus.Done => "status-done",
        TodoItemStatus.InProgress => "status-in-progress",
        _ => ""
    };
    
    private string GetStatusLabel() => Item.Status switch
    {
        TodoItemStatus.InProgress => "In Progress",
        _ => Item.Status.ToString()
    };
    
    private string GetStatusLabel(TodoItemStatus status) => status switch
    {
        TodoItemStatus.InProgress => "In Progress",
        _ => status.ToString()
    };
}
