@page "/"
@implements IDisposable
@inject ITodoService TodoService
@inject IDialogService DialogService

<PageTitle>Todo</PageTitle>

<div class="mb-3">
    <button class="btn btn-danger btn-sm" @onclick="HandleClearAll">Clear All</button>
</div>

<TodoForm Todo="@_currentTodo"
          IsEditing="@_isEditing"
          OnSubmit="HandleFormSubmit"
          OnCancel="HandleFormCancel" />

<TodoFilters Filter="@_filter"
             Sort="@_sort"
             TotalCount="@TodoService.Todos.Count"
             ActiveCount="@TodoService.GetActiveCount()"
             CompletedCount="@TodoService.GetCompletedCount()"
             FilteredCount="@GetFilteredTodos().Count()"
             FilterChanged="f => { _filter = f; }"
             SortChanged="s => { _sort = s; }" />

<h4 class="mb-3">Todos remaining: @TodoService.GetActiveCount()</h4>

<TodoListView Items="@GetFilteredTodos()"
              OnEdit="HandleEdit"
              OnDelete="HandleDelete"
              OnStatusChange="HandleStatusChange" />

@code {
    private TodoItem _currentTodo = new();
    private bool _isEditing;
    private FilterOption _filter = FilterOption.All;
    private SortOption _sort = SortOption.CreatedDate;
    private bool _initialized;

    protected override void OnInitialized()
    {
        TodoService.OnTodosChanged += StateHasChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_initialized)
        {
            _initialized = true;
            await TodoService.InitializeAsync();
            StateHasChanged();
        }
    }

    private IEnumerable<TodoItem> GetFilteredTodos() =>
        TodoService.GetFilteredAndSorted(_filter, _sort);

    private async Task HandleFormSubmit(TodoItem todo)
    {
        await TodoService.SaveTodoAsync(todo);
        ResetForm();
    }

    private void HandleFormCancel() => ResetForm();

    private void HandleEdit(TodoItem todo)
    {
        _currentTodo = todo;
        _isEditing = true;
    }

    private async Task HandleDelete(TodoItem todo)
    {
        if (await DialogService.ConfirmAsync($"Delete '{todo.Title}'?"))
            await TodoService.DeleteTodoAsync(todo);
    }

    private async Task HandleStatusChange((TodoItem todo, TodoItemStatus status) args)
    {
        await TodoService.UpdateStatusAsync(args.todo, args.status);
    }

    private async Task HandleClearAll()
    {
        if (await DialogService.ConfirmAsync("Delete ALL todos? This cannot be undone."))
        {
            await TodoService.ClearAllAsync();
            ResetForm();
        }
    }

    private void ResetForm()
    {
        _currentTodo = new TodoItem();
        _isEditing = false;
    }

    public void Dispose()
    {
        TodoService.OnTodosChanged -= StateHasChanged;
    }
}

